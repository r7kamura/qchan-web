// Generated by CoffeeScript 1.6.2
(function() {
  var Qchan;

  Qchan = {
    Repositories: {},
    Views: {}
  };

  Qchan.Controller = (function() {
    function Controller() {
      var _this = this;

      $.observable(this);
      this.user = new Qchan.User();
      this.view = new Qchan.Views.Authentication();
      this.on('load', function() {
        if (this.hasUserAttributes()) {
          this.setUserAttributes();
        }
        if (this.hasAccessToken()) {
          return this.updateUser();
        }
      });
      this.user.on('updated', function() {
        return _this.view.render(_this.user);
      });
    }

    Controller.prototype.updateUser = function() {
      return this.user.trigger('updated');
    };

    Controller.prototype.hasAccessToken = function() {
      return !!this.user.access_token;
    };

    Controller.prototype.setUserAttributes = function() {
      return this.user.set(this.userAttributes());
    };

    Controller.prototype.hasUserAttributes = function() {
      return !!Object.keys(this.userAttributes()).length;
    };

    Controller.prototype.userAttributes = function() {
      return this.__userAttributes || (this.__userAttributes = Qchan.URIFragmentParser.parse(window.location.hash));
    };

    return Controller;

  })();

  Qchan.Repositories.LocalStorageRepository = (function() {
    function LocalStorageRepository() {}

    LocalStorageRepository.prototype.get = function(key) {
      return window.localStorage.getItem(key);
    };

    LocalStorageRepository.prototype.set = function(key, value) {
      return window.localStorage.setItem(key, value);
    };

    return LocalStorageRepository;

  })();

  Qchan.Repository = (function() {
    function Repository() {}

    Repository.table = {};

    Repository.register = function(name, storage) {
      return this.table[name] = storage;
    };

    Repository["for"] = function(name) {
      return this.table[name];
    };

    return Repository;

  })();

  Qchan.URIFragmentParser = (function() {
    URIFragmentParser.parse = function(fragment) {
      return new this(fragment).parse();
    };

    function URIFragmentParser(fragment) {
      this.fragment = fragment;
    }

    URIFragmentParser.prototype.parse = function() {
      var key, segment, table, value, _i, _len, _ref, _ref1;

      table = {};
      _ref = this.segments();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        segment = _ref[_i];
        _ref1 = segment.split('=', 2), key = _ref1[0], value = _ref1[1];
        if (value) {
          table[key] = window.decodeURIComponent(value);
        }
      }
      return table;
    };

    URIFragmentParser.prototype.segments = function() {
      return this.fragment.substr(1).split('&');
    };

    return URIFragmentParser;

  })();

  Qchan.User = (function() {
    function User() {
      $.observable(this);
      this.repository = Qchan.Repository["for"]('user');
      this.keys = ['access_token', 'email', 'name'];
      this.sync();
    }

    User.prototype.set = function(attributes) {
      var key, _i, _len, _ref, _results;

      _ref = this.keys;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        key = _ref[_i];
        _results.push(this.repository.set(key, this[key] = attributes[key]));
      }
      return _results;
    };

    User.prototype.sync = function() {
      var key, _i, _len, _ref, _results;

      _ref = this.keys;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        key = _ref[_i];
        _results.push(this[key] = this.repository.get(key));
      }
      return _results;
    };

    return User;

  })();

  Qchan.Views.Authentication = (function() {
    function Authentication() {
      this.template = $('#authentication-template').html();
      this.container = $('#authentication');
    }

    Authentication.prototype.render = function(user) {
      return this.container.html($.render(this.template, user));
    };

    return Authentication;

  })();

  Qchan.Repository.register('user', new Qchan.Repositories.LocalStorageRepository());

  $(function() {
    var controller;

    controller = new Qchan.Controller;
    return controller.trigger('load');
  });

}).call(this);
